<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Easy Gift</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        :root {
            /* –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ —Ç–µ–º—ã Telegram */
            --tg-bg: var(--tg-theme-bg-color, #1a1a1a);
            --tg-text: var(--tg-theme-text-color, #ffffff);
            --tg-hint: var(--tg-theme-hint-color, #999);
            --tg-link: var(--tg-theme-link-color, #007aff);
            --tg-button: var(--tg-theme-button-color, #007aff);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #2c2c2e);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 15px;
            background-color: var(--tg-bg);
            color: var(--tg-text);
            padding-bottom: 80px; 
            box-sizing: border-box;
        }

        /* --- –ö–∞—Ä—Ç–æ—á–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è --- */
        .user-card {
            background-color: var(--tg-secondary-bg);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            margin-right: 12px;
            background-color: #555; 
        }

        .user-info { flex-grow: 1; }
        .user-name { font-size: 17px; font-weight: 600; }
        .user-subtext { font-size: 14px; color: var(--tg-hint); }

        /* --- –ë–ª–æ–∫ —Å–æ –∑–≤–µ–∑–¥–∞–º–∏ (–∏–∑–º–µ–Ω–µ–Ω) --- */
        .stars-block {
            display: flex;
            align-items: center;
            color: var(--tg-hint);
            font-weight: 500;
        }

        .stars-block .stars-count {
            background-color: rgba(0,0,0,0.2);
            padding: 4px 10px;
            border-radius: 20px;
            display: flex;
            align-items: center;
        }
        
        .stars-block span { margin-left: 5px; }
        
        /* –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê + */
        .add-button {
            background-color: var(--tg-button);
            color: var(--tg-button-text);
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            font-size: 24px;
            font-weight: 500;
            line-height: 30px;
            text-align: center;
            margin-left: 10px;
            cursor: pointer;
        }
        
        /* ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ –ø—Ä–∏–º–µ—Ä–∞: .empty-state, .bottom-nav, etc.) ... */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--tg-secondary-bg); border-top: 1px solid rgba(150, 150, 150, 0.2); display: flex; justify-content: space-around; padding-top: 8px; padding-bottom: calc(env(safe-area-inset-bottom) + 8px); }
        .nav-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; font-size: 10px; color: var(--tg-hint); padding: 0 5px; }
        .nav-item.active { color: var(--tg-link); }
        .nav-icon { font-size: 24px; margin-bottom: 4px; }


        /* --- –ù–û–í–´–ô –ë–õ–û–ö: –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.6);
            display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            align-items: flex-end; /* –ü—Ä–∏–∂–∏–º–∞–µ–º –∫ –Ω–∏–∑—É */
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--tg-secondary-bg);
            border-radius: 12px 12px 0 0;
            padding: 20px;
            width: 100%;
            max-width: 500px; /* –î–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞ */
            box-sizing: border-box;
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .close-button {
            cursor: pointer;
            font-size: 28px;
            color: var(--tg-hint);
            line-height: 1;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            background-color: var(--tg-bg);
            border-radius: 8px;
            padding: 4px;
        }
        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            color: var(--tg-hint);
            font-weight: 500;
        }
        .tab.active {
            background-color: var(--tg-secondary-bg);
            color: var(--tg-text);
        }

        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--tg-hint);
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--tg-bg);
            background-color: var(--tg-bg);
            color: var(--tg-text);
            font-size: 18px;
            box-sizing: border-box;
        }
        
        /* –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è numeric –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞, –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã */
        .input-group input[type="number"] {
            -moz-appearance: textfield; /* Firefox */
        }
        .input-group input::-webkit-outer-spin-button,
        .input-group input::-webkit-inner-spin-button {
            -webkit-appearance: none; /* Chrome, Safari, Edge, Opera */
            margin: 0;
        }

        .submit-button {
            width: 100%;
            padding: 15px;
            font-size: 17px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            background-color: var(--tg-button);
            color: var(--tg-button-text);
        }

    </style>
</head>
<body>

    <div class="user-card">
        <img id="user-avatar-1" class="avatar" src="" alt="avatar"> 
        <div class="user-info">
            <div id="user-name-1" class="user-name">...</div>
            <div class="user-subtext"><span id="stars-balance">0</span> –∑–≤—ë–∑–¥ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
        </div>
        <div class="stars-block">
            <div class="stars-count">‚≠ê <span id="stars-balance-2">0</span></div>
        </div>
        <button class="add-button" id="open-modal-button">+</button>
    </div>
    
    <div class="modal-overlay" id="payment-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</span>
                <span class="close-button" id="close-modal-button">&times;</span>
            </div>

            <div class="tabs">
                <div class="tab active">‚≠ê –ó–≤—ë–∑–¥—ã</div>
                <div class="tab">üíé TON <small>(—Å–∫–æ—Ä–æ)</small></div>
            </div>

            <div class="input-group">
                <label for="stars-amount">–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É</label>
                <input type="number" id="stars-amount" placeholder="500" inputmode="numeric">
            </div>

            <button class="submit-button" id="submit-payment-button">
                –ü–æ–ø–æ–ª–Ω–∏—Ç—å –∑–≤—ë–∑–¥–∞–º–∏
            </button>
        </div>
    </div>
    
    <nav class="bottom-nav">
        <a href="#" class="nav-item active"><span class="nav-icon">üè†</span>–ì–ª–∞–≤–Ω–∞—è</a>
        <a href="#" class="nav-item"><span class="nav-icon">üîº</span>–ê–ø–≥—Ä–µ–π–¥</a>
        <a href="#" class="nav-item"><span class="nav-icon">üèÜ</span>–†–µ–π—Ç–∏–Ω–≥</a>
        <a href="#" class="nav-item"><span class="nav-icon">üë§</span>–ü—Ä–æ—Ñ–∏–ª—å</a>
        <a href="#" class="nav-item"><span class="nav-icon">üïí</span>–ò—Å—Ç–æ—Ä–∏—è</a>
    </nav>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand(); 
                tg.BackButton.show(); 
                tg.BackButton.onClick(() => tg.close());

                // --- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ---
                const user = tg.initDataUnsafe.user;
                if (user) {
                    const userName = user.first_name || user.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                    document.getElementById('user-name-1').innerText = userName;
                    if (user.photo_url) {
                        document.getElementById('user-avatar-1').src = user.photo_url;
                    }
                }

                // --- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ ---
                const modal = document.getElementById('payment-modal');
                const openButton = document.getElementById('open-modal-button');
                const closeButton = document.getElementById('close-modal-button');
                const submitButton = document.getElementById('submit-payment-button');
                const amountInput = document.getElementById('stars-amount');

                openButton.addEventListener('click', () => {
                    modal.style.display = 'flex';
                });

                closeButton.addEventListener('click', () => {
                    modal.style.display = 'none';
                });
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });

                // --- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –í—ã–∑–æ–≤ –æ–ø–ª–∞—Ç—ã ---
                submitButton.addEventListener('click', () => {
                    const amount = parseInt(amountInput.value);

                    if (isNaN(amount) || amount <= 0) {
                        tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É.');
                        return;
                    }

                    // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –ø–ª–∞—Ç–µ–∂–∞ –¥–ª—è –≤–∞—à–µ–≥–æ –±—ç–∫–µ–Ω–¥–∞
                    const payload = `topup-${user.id}-${amount}-${Date.now()}`;

                    // 1. –í—ã–∑—ã–≤–∞–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–π –∏–Ω–≤–æ–π—Å Telegram
                    tg.showInvoice({
                        type: 'stars',
                        payload: payload,
                        amount: amount // –°—É–º–º–∞ –≤ –∑–≤–µ–∑–¥–∞—Ö
                    }, 
                    // 2. –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è-–∫–æ–ª–ª–±—ç–∫ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –ü–û–°–õ–ï —Ç–æ–≥–æ, 
                    // –∫–∞–∫ –±—ç–∫–µ–Ω–¥ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –ø–ª–∞—Ç–µ–∂
                    (status, invoice_payload) => {
                        console.log('Invoice callback:', status, invoice_payload);

                        if (status === 'paid') {
                            tg.HapticFeedback.notificationOccurred('success');
                            tg.showAlert('–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ! –ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω.');
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –Ω–∞ UI (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ - 
                            // –∑–∞–ø—Ä–æ—Å–∏—Ç–µ –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å —Å –±—ç–∫–µ–Ω–¥–∞)
                            const currentBalance = parseInt(document.getElementById('stars-balance').innerText) || 0;
                            const newBalance = currentBalance + amount;
                            document.getElementById('stars-balance').innerText = newBalance;
                            document.getElementById('stars-balance-2').innerText = newBalance;
                            
                            modal.style.display = 'none';
                            amountInput.value = '';
                        } else if (status === 'failed') {
                            tg.HapticFeedback.notificationOccurred('error');
                            tg.showAlert('–û–ø–ª–∞—Ç–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
                        } else if (status === 'cancelled') {
                            tg.HapticFeedback.notificationOccurred('warning');
                        }
                    });
                });

            } catch (e) {
                console.error(e);
                document.body.innerHTML = '<h2>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ Telegram.</h2>';
            }
        });
    </script>

</body>
</html>
