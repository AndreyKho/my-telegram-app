<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Easy Gift</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #1a1a1a);
            --tg-text: var(--tg-theme-text-color, #ffffff);
            --tg-hint: var(--tg-theme-hint-color, #999);
            --tg-link: var(--tg-theme-link-color, #007aff);
            --tg-button: var(--tg-theme-button-color, #007aff);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #2c2c2e);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 15px; background-color: var(--tg-bg); color: var(--tg-text); padding-bottom: 80px; box-sizing: border-box; }
        .user-card { background-color: var(--tg-secondary-bg); border-radius: 12px; padding: 15px; display: flex; align-items: center; margin-bottom: 10px; }
        .avatar { width: 44px; height: 44px; border-radius: 50%; margin-right: 12px; background-color: #555; }
        .user-info { flex-grow: 1; }
        .user-name { font-size: 17px; font-weight: 600; }
        .user-subtext { font-size: 14px; color: var(--tg-hint); }
        .stars-block { display: flex; align-items: center; color: var(--tg-hint); font-weight: 500; }
        .stars-block .stars-count { background-color: rgba(0,0,0,0.2); padding: 4px 10px; border-radius: 20px; display: flex; align-items: center; }
        .stars-block span { margin-left: 5px; }
        .add-button { background-color: var(--tg-button); color: var(--tg-button-text); border: none; width: 30px; height: 30px; border-radius: 50%; font-size: 24px; font-weight: 500; line-height: 30px; text-align: center; margin-left: 10px; cursor: pointer; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--tg-secondary-bg); border-top: 1px solid rgba(150, 150, 150, 0.2); display: flex; justify-content: space-around; padding-top: 8px; padding-bottom: calc(env(safe-area-inset-bottom) + 8px); }
        .nav-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; font-size: 10px; color: var(--tg-hint); padding: 0 5px; }
        .nav-item.active { color: var(--tg-link); }
        .nav-icon { font-size: 24px; margin-bottom: 4px; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.6); display: none; align-items: flex-end; justify-content: center; z-index: 1000; }
        .modal-content { background-color: var(--tg-secondary-bg); border-radius: 12px 12px 0 0; padding: 20px; width: 100%; max-width: 500px; box-sizing: border-box; position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; font-size: 20px; font-weight: 600; margin-bottom: 20px; }
        .close-button { cursor: pointer; font-size: 28px; color: var(--tg-hint); line-height: 1; }
        .tabs { display: flex; margin-bottom: 20px; background-color: var(--tg-bg); border-radius: 8px; padding: 4px; }
        .tab { flex: 1; padding: 10px; text-align: center; border-radius: 6px; cursor: pointer; color: var(--tg-hint); font-weight: 500; }
        .tab.active { background-color: var(--tg-secondary-bg); color: var(--tg-text); }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-size: 14px; color: var(--tg-hint); }
        .input-group input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--tg-bg); background-color: var(--tg-bg); color: var(--tg-text); font-size: 18px; box-sizing: border-box; }
        .input-group input[type="number"] { -moz-appearance: textfield; }
        .input-group input::-webkit-outer-spin-button, .input-group input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .submit-button { width: 100%; padding: 15px; font-size: 17px; font-weight: 600; border: none; border-radius: 12px; cursor: pointer; background-color: var(--tg-button); color: var(--tg-button-text); }
    </style>
</head>
<body>
    <div class="user-card">
        <img id="user-avatar-1" class...
    </div>
    <div class="modal-overlay" id="payment-modal">
        ...
    </div>
    <nav class="bottom-nav">
        ...
    </nav>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand(); 
                tg.BackButton.show(); 
                tg.BackButton.onClick(() => tg.close());

                // --- Авторизация (как и была) ---
                const user = tg.initDataUnsafe.user;
                if (user) {
                    const userName = user.first_name || user.username || 'Пользователь';
                    document.getElementById('user-name-1').innerText = userName;
                    if (user.photo_url) {
                        document.getElementById('user-avatar-1').src = user.photo_url;
                    }
                }

                // --- Модальное окно (как и было) ---
                const modal = document.getElementById('payment-modal');
                const openButton = document.getElementById('open-modal-button');
                const closeButton = document.getElementById('close-modal-button');
                const submitButton = document.getElementById('submit-payment-button');
                const amountInput = document.getElementById('stars-amount');

                openButton.addEventListener('click', () => modal.style.display = 'flex');
                closeButton.addEventListener('click', () => modal.style.display = 'none');
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.style.display = 'none';
                });

                // --- ОБНОВЛЕННАЯ ЛОГИКА ВЫЗОВА ОПЛАТЫ ---
                submitButton.addEventListener('click', () => {
                    const amount = parseInt(amountInput.value);

                    if (isNaN(amount) || amount <= 0) {
                        tg.showAlert('Пожалуйста, введите корректную сумму.');
                        return;
                    }

                    const payload = `topup-${user.id}-${amount}-${Date.now()}`;

                    try {
                        // 1. Вызываем нативный инвойс
                        tg.showInvoice({
                            type: 'stars',
                            payload: payload,
                            amount: amount 
                        }, 
                        // 2. ОБНОВЛЕННЫЙ КОЛЛБЭК ДЛЯ ОТЛАДКИ
                        (status, invoice_payload) => {
                            console.log('Invoice callback status:', status);

                            if (status === 'paid') {
                                // Этот код у вас не выполнится, т.к. бэкенд не получит PreCheckoutQuery
                                tg.HapticFeedback.notificationOccurred('success');
                                tg.showAlert('Оплата прошла успешно! Баланс обновлен.');
                                // ... (код обновления баланса) ...
                            
                            } else if (status === 'failed') {
                                // Скорее всего, вы увидите это
                                tg.HapticFeedback.notificationOccurred('error');
                                tg.showAlert(`Оплата не удалась. (Статус: ${status})`);
                            
                            } else if (status === 'cancelled') {
                                // Или это
                                tg.HapticFeedback.notificationOccurred('warning');
                                tg.showAlert(`Оплата отменена. (Статус: ${status})`);
                            }
                        });
                    
                    } catch (error) {
                        // 3. ДОБАВЛЕН БЛОК CATCH ДЛЯ ПЕРЕХВАТА ОШИБКИ
                        console.error('Ошибка вызова showInvoice:', error);
                        tg.showAlert(`Ошибка вызова showInvoice: ${error.message}`);
                    }
                });

            } catch (e) {
                console.error(e);
                document.body.innerHTML = '<h2>Пожалуйста, откройте это приложение внутри Telegram.</h2>';
            }
        });
    </script>
</body>
</html>
